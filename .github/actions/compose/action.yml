name: compose build and up
description: Runs docker-compose up and waits for stuff to stay awake

inputs:
  application-name:
    required: true
    type: string

runs:
  using: composite
  # TODO: maybe extract stuff to a script?
  # - run: ${{ github.action_path }}/test/script.sh
  #   shell: bash
  steps:
  - name: Pull dependencies
    shell: bash
    run: docker-compose -f docker-compose.test.yml pull 2>&1 | grep -v -E '^Pulling .*\.\. (extracting |downloading |waiting|pulling fs )'

  - name: Build and/or start docker image
    shell: bash
    run: docker-compose -f docker-compose.test.yml up -d

  - name: Prepare database
    shell: bash
    run: |
      docker-compose -f docker-compose.test.yml exec -T ${{ inputs.application-name }} bin/rails db:drop db:create db:test:prepare

  - name: Wait while starting
    shell: bash
    run: |
      sleep 5
      tries=20
      while :; do
        tries=$(( tries - 1 ))
        SERVICES=$(docker-compose -f docker-compose.test.yml ps)
        if echo $SERVICES | grep -q '(health: starting)'
        then
          echo " -- Still waiting ($tries more) ..."
          echo
          echo "$SERVICES" | grep '(health: starting)'
          if [[ $tries -lt 0 ]]; then
            echo "Too many retries. Giving up."
            exit 1
          fi
          sleep 2
        else
          echo " -- No more starting services..."
          echo "$SERVICES"
          break
        fi
      done

  - name: Count started
    shell: bash
    run: |
      n=$(ruby -e "require 'yaml'; print YAML.load_file('docker-compose.test.yml')['services'].count")
      echo " --- Checking if all ${n} services are running..."
      RUNNING=$(docker-compose -f docker-compose.test.yml ps --services --filter "status=running" | wc -l)
      if [ "$RUNNING" != "$n" ]; then
        echo "not all services are running"
        docker-compose -f docker-compose.test.yml logs
        exit 1
      fi

  - name: Check if app is healthy
    shell: bash
    run: |
      STATUS=$(docker inspect --format "{{.State.Health.Status}}" $(docker-compose -f docker-compose.test.yml ps -q ${{ inputs.application-name}}))
      if [ "$STATUS" != "healthy" ]
      then
        echo "${{ inputs.application-name }} is not healthy:"
        docker-compose -f docker-compose.test.yml ps
        exit 1
      fi
